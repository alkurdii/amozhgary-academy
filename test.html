

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ¹Ù„ - Arabic Verb Types</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');

        :root {
            --bg-color: #f8fafc;
            --line-color: #cbd5e1;
            --root-bg: #0f172a;
            --root-text: #ffffff;
            --node-bg: #ffffff;
            --node-text: #1e293b;
            --hover-color: #3b82f6;
            --accent-color: #0ea5e9;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 10px;
            direction: rtl;
            display: flex;
            justify-content: center;
        }

        .tab-container {
            width: 100%;
            max-width: 1000px;
        }

        .tab-buttons {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            background: var(--bg-color);
            padding: 10px 0;
            z-index: 1000;
        }

        .tab-button {
            padding: 8px 16px;
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            border: 2px solid var(--line-color);
            background-color: var(--node-bg);
            color: var(--node-text);
            border-radius: 8px;
            cursor: pointer;
            transition: 0.3s;
        }

        .tab-button.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        /* Search Bar */
        .search-container {
            margin-bottom: 15px;
            text-align: center;
        }

        #search-input {
            width: 100%;
            box-sizing: border-box;
            padding: 12px;
            border: 2px solid var(--line-color);
            border-radius: 12px;
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }

        #search-input:focus {
            border-color: var(--accent-color);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Tree Styling */
        .tree ul {
            padding-top: 20px; 
            position: relative;
            display: flex;
            justify-content: center;
            padding-right: 0;
        }

        .tree li {
            text-align: center;
            list-style-type: none;
            position: relative;
            padding: 20px 5px 0 5px;
        }

        .tree li::before, .tree li::after {
            content: '';
            position: absolute;
            top: 0;
            right: 50%;
            border-top: 3px solid var(--branch-color, var(--line-color));
            width: 50%;
            height: 20px;
        }

        .tree li::after {
            left: 50%;
            border-left: 3px solid var(--branch-color, var(--line-color));
        }

        .tree li:only-child::after, .tree li:only-child::before { display: none; }
        .tree li:only-child { padding-top: 0; }
        .tree li:first-child::before, .tree li:last-child::after { border: 0; }
        .tree li:last-child::before { border-left: 3px solid var(--branch-color, var(--line-color)); border-radius: 0 15px 0 0; }
        .tree li:first-child::after { border-radius: 15px 0 0 0; }

        .tree ul ul::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            border-left: 3px solid var(--branch-color, var(--line-color));
            width: 0;
            height: 20px;
        }

        .node {
            border: 2px solid var(--branch-color, var(--line-color));
            padding: 6px 10px;
            color: var(--node-text);
            font-size: 0.85rem;
            font-weight: 700;
            display: inline-block;
            border-radius: 8px;
            background: var(--node-bg);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            min-width: 80px;
        }

        .tree > ul > li > .node {
            background-color: var(--root-bg);
            color: white;
            font-size: 1.1rem;
            padding: 10px 20px;
        }

        /* Branch Colors */
        /* Level 1 */
        .tree > ul > li > ul > li:nth-child(1) { --branch-color: #ef4444; } /* Red */
        .tree > ul > li > ul > li:nth-child(2) { --branch-color: #3b82f6; } /* Blue */
        .tree > ul > li > ul > li:nth-child(3) { --branch-color: #10b981; } /* Green */
        .tree > ul > li > ul > li:nth-child(4) { --branch-color: #f59e0b; } /* Orange */

        /* Level 2 */
        .tree > ul > li > ul > li > ul > li:nth-child(1) { --branch-color: #ec4899; } /* Pink */
        .tree > ul > li > ul > li > ul > li:nth-child(2) { --branch-color: #8b5cf6; } /* Violet */
        .tree > ul > li > ul > li > ul > li:nth-child(3) { --branch-color: #06b6d4; } /* Cyan */

        /* Level 3 */
        .tree > ul > li > ul > li > ul > li > ul > li:nth-child(1) { --branch-color: #be185d; } /* Dark Pink */
        .tree > ul > li > ul > li > ul > li > ul > li:nth-child(2) { --branch-color: #4338ca; } /* Dark Indigo */

        /* Responsive / Mobile View */
        @media (max-width: 768px) {
            .tree, .tree ul, .tree li {
                display: block;
                text-align: right;
            }

            .tree li {
                padding: 5px 8px 0 0;
                margin-right: 8px;
                border-right: 3px solid var(--branch-color, var(--line-color));
            }

            .tree li::before, .tree li::after, .tree ul ul::before {
                display: none;
            }

            .tree li::after {
                content: '';
                position: absolute;
                right: 0;
                top: 17px;
                width: 8px;
                height: 3px;
                background: var(--branch-color, var(--line-color));
                display: block;
            }

            .node {
                width: auto;
                max-width: 95%;
                font-size: 0.95rem; /* Increased font size for readability */
                padding: 4px 8px;
                min-width: auto;
            }

            .tree > ul > li > .node {
                font-size: 0.9rem;
                padding: 6px 12px;
            }

            .tree > ul > li {
                border-right: none;
                padding-right: 0;
                margin-right: 0;
            }

            .tree > ul > li::after { display: none; }

            /* Collapsible Logic for Mobile (Accordion Style) */
            .tree ul ul {
                display: none; /* Hide sub-branches by default */
            }

            .tree li.expanded > ul {
                display: block; /* Show when expanded */
                animation: fadeIn 0.3s ease;
            }

            .node.has-children {
                cursor: pointer;
                position: relative;
                padding-left: 30px; /* Space for the +/- icon */
            }

            .node.has-children::after {
                content: '+';
                position: absolute;
                left: 10px;
                top: 50%;
                transform: translateY(-50%);
                font-weight: bold;
                font-size: 1.2em;
            }

            .tree li.expanded > .node.has-children::after {
                content: '-';
            }

            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        }

        /* I'rab Result Box (Advanced Feature) */
        #irab-box {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px 20px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            border-top: 4px solid var(--accent-color);
            z-index: 2000;
            transform: translateY(120%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            border-radius: 15px 15px 0 0;
        }

        #irab-box.visible {
            transform: translateY(0);
        }

        #irab-text {
            font-size: 1rem;
            font-weight: 700;
            color: var(--node-text);
            line-height: 1.6;
        }

        /* Leaf Node Input Box (Writing Box) */
        .leaf-input-container {
            margin-top: 10px;
            display: flex;
            justify-content: center;
        }
        
        .leaf-input {
            width: 120px;
            height: 40px;
            padding: 8px;
            border: 2px solid var(--line-color);
            border-radius: 8px;
            font-family: 'Tajawal', sans-serif;
            font-size: 0.8rem;
            resize: none;
            transition: border-color 0.3s;
            background-color: #ffffff;
        }

        .leaf-input-container {
            display: none;
            flex-direction: column;
            align-items: center;
            margin-top: 10px;
            gap: 5px;
        }
        .leaf-input-container.visible {
            display: flex;
        }
        .add-note-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        .add-note-btn:hover { background-color: #0284c7; }
        
        .leaf-input:focus {
            border-color: var(--accent-color);
            outline: none;
        }

        /* Report Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: white;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            border-radius: 15px;
            padding: 20px;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .report-item {
            border-bottom: 1px solid #e2e8f0;
            padding: 15px 0;
        }
        .report-path { font-weight: 700; color: var(--accent-color); font-size: 0.9rem; margin-bottom: 8px; }
        .report-answer { background: #f8fafc; padding: 10px; border-radius: 8px; color: #334155; border: 1px solid #e2e8f0; white-space: pre-wrap; }
        .report-empty { color: #ef4444; font-style: italic; background: #fef2f2; border-color: #fee2e2; }
        .close-modal {
            position: sticky;
            top: 0;
            float: left;
            background: #ef4444; color: white;
            border: none; padding: 8px 15px;
            border-radius: 8px; cursor: pointer;
            font-family: inherit;
            z-index: 10;
        }
        .report-title { text-align: center; font-weight: bold; margin-bottom: 20px; font-size: 1.2rem; border-bottom: 2px solid var(--line-color); padding-bottom: 10px; }
        
        /* Floating Report Button (FAB) */
        #show-report-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 2500;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8rem;
            cursor: pointer;
            transition: transform 0.2s;
        }
        #show-report-btn:active { transform: scale(0.95); }
        
        #report-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 0.8rem;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid white;
            font-weight: bold;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        
        /* Help Button */
        #help-btn {
            position: fixed;
            bottom: 90px; /* Above the report button */
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #64748b;
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 2500;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s;
        }
        #help-btn:active { transform: scale(0.95); }

        /* Start Label Animation */
        .start-label {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-color);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            white-space: nowrap;
            animation: bounce 2s infinite;
        }
        .start-label::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid var(--accent-color);
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateX(-50%) translateY(0);}
            40% {transform: translateX(-50%) translateY(-5px);}
            60% {transform: translateX(-50%) translateY(-3px);}
        }

        /* Advanced Report Summary */
        .report-summary {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #cbd5e1;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 5px;
        }
        .summary-row:last-child { border-bottom: none; }
        .summary-label { font-weight: bold; color: var(--node-text); }
        .summary-value { font-weight: bold; color: var(--accent-color); }
        .progress-bar { width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: #10b981; width: 0%; transition: width 0.5s ease; }
        .summary-header { text-align: center; margin-bottom: 15px; }

        .share-btn {
            background-color: #229ED9;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            margin-top: 20px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: background 0.2s;
            font-weight: bold;
        }
        .share-btn:hover { background-color: #1b8ac0; }
        
        .copy-btn {
            background-color: #64748b;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            margin-top: 10px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: background 0.2s;
            font-weight: bold;
        }
        .copy-btn:hover { background-color: #475569; }

        .txt-btn {
            background-color: #8b5cf6;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            margin-top: 10px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: background 0.2s;
            font-weight: bold;
        }
        .txt-btn:hover { background-color: #7c3aed; }

        .action-btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .export-btn, .clear-all-btn, .import-btn {
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-weight: bold;
            flex: 1;
            transition: opacity 0.2s;
        }
        .export-btn { background-color: #10b981; }
        .import-btn { background-color: #3b82f6; }
        .clear-all-btn { background-color: #ef4444; }
        .export-btn:hover, .clear-all-btn:hover, .import-btn:hover { opacity: 0.9; }

        /* Login Styles */
        .login-box {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 350px;
            width: 90%;
        }
        /* Interactive Report Styles */
        .report-verb-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .report-verb-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        .report-verb-text {
            flex: 1;
            margin-left: 10px;
            font-weight: bold;
            color: #334155;
            white-space: pre-wrap;
        }
        .report-verb-actions {
            display: flex;
            gap: 5px;
        }
        .report-verb-actions button {
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1.1rem;
            padding: 2px 5px;
            transition: transform 0.2s;
        }
        .report-verb-actions button:hover {
            transform: scale(1.2);
        }
        
        /* Toast Notification (Ù¾Û•ÛŒØ§Ù…Ø§ Ù¾Ø§Ø±Ø§Ø³ØªÙ†Û) */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 12px;
            position: fixed;
            z-index: 4000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 0.9rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
            font-family: 'Tajawal', sans-serif;
        }
        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }

        /* Collapsible Report Styles */
        .report-verb-list {
            display: none; /* Hidden by default */
            max-height: 300px; /* Scrollable if very long */
            overflow-y: auto;
            margin-top: 10px;
            border-top: 1px dashed #cbd5e1;
            padding-top: 10px;
        }
        .report-verb-list.expanded { display: flex; }
        .report-path {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .report-path:hover { background-color: #f1f5f9; border-radius: 5px; padding: 2px 5px; }
        .toggle-icon {
            font-size: 0.8rem;
            background: #e2e8f0;
            padding: 2px 8px;
            border-radius: 12px;
            color: #475569;
        }

        @media (max-width: 768px) {
            .leaf-input-container {
                display: none;
                padding-right: 0;
            }
            .leaf-input {
                width: 95%;
                height: 60px;
                margin-top: 5px;
            }
        }
        
        .reset-btn {
            margin-top: 10px;
            background: var(--bg-color);
            border: 1px solid var(--line-color);
            padding: 5px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .node.selected {
            background-color: var(--accent-color) !important;
            color: white !important;
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.3);
        }
        
        body.has-irab-box {
            padding-bottom: 120px; /* Space for the box */
        }

        .node.dimmed { opacity: 0.2; }
        .node.highlight-search { 
            background-color: #fef08a !important; 
            color: black !important;
            border-color: #eab308 !important;
        }
        
        /* Grading Styles */
        .report-verb-row.correct { background-color: #dcfce7; border-color: #86efac; }
        .report-verb-row.correct .report-verb-text { color: #166534; }
        
        .report-verb-row.wrong { background-color: #fee2e2; border-color: #fca5a5; }
        .report-verb-row.wrong .report-verb-text { color: #991b1b; }
        
        .correction-hint { display: block; font-size: 0.85rem; color: #b91c1c; margin-top: 4px; font-weight: bold; }
    </style>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

    <div class="tab-container">
        <div class="search-container">
            <input type="text" id="search-input" placeholder="Ø¨Ú¯Û•Ú•Û... (Ù†Ù…ÙˆÙˆÙ†Û•: Ø§Ù„Ø³ÙƒÙˆÙ†)">
        </div>
        <div class="tab-buttons">
            <button class="tab-button" data-target="madi">Ù…Ø§Ø¶Ù</button>
            <button class="tab-button" data-target="mudari">Ù…Ø¶Ø§Ø±Ø¹</button>
            <button class="tab-button" data-target="amr">Ø£Ù…Ø±</button>
        </div>

        <!-- Ø§Ù„Ù…Ø§Ø¶ÙŠ -->
        <div id="madi" class="tab-content">
            <div class="tree">
                <ul>
                    <li>
                        <div class="node" style="position: relative;">
                            Ù…Ø§Ø¶Ù Ù…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰
                        </div>
                        <ul>
                            <li><div class="node">Ø§Ù„ÙØªØ­ Ù„Ø£Ù†Ù‡ Ù„Ù… ÙŠØªØµÙ„ Ø¨Ø¢Ø®Ø±Ù‡ Ø´ÙŠØ¡</div></li>
                            <li>
                                <div class="node">Ø§Ù„Ø³ÙƒÙˆÙ† Ù„Ø§ØªØµØ§Ù„Ù‡ Ø¨Ù€</div>
                                <ul>
                                    <li><div class="node">ØªØ§Ø¡ Ø§Ù„ÙØ§Ø¹Ù„</div></li>
                                    <li><div class="node">Ù†Ø§ Ø§Ù„ÙØ§Ø¹Ù„ÙŠÙ†</div></li>
                                    <li><div class="node">Ù†ÙˆÙ† Ø§Ù„Ù†Ø³ÙˆØ©</div></li>
                                </ul>
                            </li>
                            <li><div class="node">Ø§Ù„Ø¶Ù… Ù„Ø§ØªØµØ§Ù„Ù‡ Ø¨ÙˆØ§Ùˆ Ø§Ù„Ø¬Ù…Ø§Ø¹Ø©</div></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Ø§Ù„Ù…Ø¶Ø§Ø±Ø¹ -->
        <div id="mudari" class="tab-content">
            <div class="tree">
                <ul>
                    <li>
                        <div class="node" style="position: relative;">
                            Ù…Ø¶Ø§Ø±Ø¹
                        </div>
                        <ul>
                            <li>
                                <div class="node">Ù…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰</div>
                                <ul>
                                    <li><div class="node">Ø§Ù„Ø³ÙƒÙˆÙ† Ù„Ø§ØªØµØ§Ù„Ù‡ Ø¨Ù†ÙˆÙ† Ø§Ù„Ù†Ø³ÙˆØ©</div></li>
                                    <li>
                                        <div class="node">Ø§Ù„ÙØªØ­ Ù„Ø§ØªØµØ§Ù„Ù‡ Ø¨Ù†ÙˆÙ† Ø§Ù„ØªÙˆÙƒÙŠØ¯</div>
                                        <ul>
                                            <li><div class="node">Ø§Ù„Ø«Ù‚ÙŠÙ„Ø©</div></li>
                                            <li><div class="node">Ø§Ù„Ø®ÙÙŠÙØ©</div></li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                            <li>
                                <div class="node">Ù…Ø±ÙÙˆØ¹ ÙˆØ¹Ù„Ø§Ù…Ø© Ø±ÙØ¹Ù‡</div>
                                <ul>
                                    <li>
                                        <div class="node">Ø§Ù„Ø¶Ù…Ø©</div>
                                        <ul>
                                            <li><div class="node">Ø§Ù„Ø¸Ø§Ù‡Ø±Ø©</div></li>
                                            <li>
                                                <div class="node">Ø§Ù„Ù…Ù‚Ø¯Ø±Ø© Ø¹Ù„Ù‰</div>
                                                <ul>
                                                    <li><div class="node">Ø§Ù„Ø£Ù„Ù Ù„Ù„ØªØ¹Ø°Ø±</div></li>
                                                    <li><div class="node">(Ø§Ù„ÙˆØ§Ùˆ) Ø£Ùˆ (Ø§Ù„ÙŠØ§Ø¡) Ù„Ù„Ø«Ù‚Ù„</div></li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </li>
                                    <li><div class="node">Ø«Ø¨ÙˆØª Ø§Ù„Ù†ÙˆÙ†</div></li>
                                </ul>
                            </li>
                            <li>
                                <div class="node">Ù…Ù†ØµÙˆØ¨ ÙˆØ¹Ù„Ø§Ù…Ø© Ù†ØµØ¨Ù‡</div>
                                <ul>
                                    <li>
                                        <div class="node">Ø§Ù„ÙØªØ­Ø©</div>
                                        <ul>
                                            <li><div class="node">Ø§Ù„Ø¸Ø§Ù‡Ø±Ø©</div></li>
                                            <li><div class="node">Ø§Ù„Ù…Ù‚Ø¯Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù„Ù Ù„Ù„ØªØ¹Ø°Ø±</div></li>
                                        </ul>
                                    </li>
                                    <li><div class="node">Ø­Ø°Ù Ø§Ù„Ù†ÙˆÙ†</div></li>
                                </ul>
                            </li>
                            <li>
                                <div class="node">Ù…Ø¬Ø²ÙˆÙ… ÙˆØ¹Ù„Ø§Ù…Ø© Ø¬Ø²Ù…Ù‡</div>
                                <ul>
                                    <li><div class="node">Ø§Ù„Ø³ÙƒÙˆÙ†</div></li>
                                    <li><div class="node">Ø­Ø°Ù Ø­Ø±Ù Ø§Ù„Ø¹Ù„Ø© Ù„Ø£Ù†Ù‡ Ù…Ø¹ØªÙ„ Ø§Ù„Ø¢Ø®Ø±</div></li>
                                    <li><div class="node">Ø­Ø°Ù Ø§Ù„Ù†ÙˆÙ† Ù„Ø£Ù†Ù‡ Ù…Ù† Ø§Ù„Ø£ÙØ¹Ø§Ù„ Ø§Ù„Ø®Ù…Ø³Ø©</div></li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Ø§Ù„Ø£Ù…Ø± -->
        <div id="amr" class="tab-content">
            <div class="tree">
                <ul>
                    <li>
                        <div class="node" style="position: relative;">
                            Ø£Ù…Ø± Ù…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰
                        </div>
                        <ul>
                            <li><div class="node">Ø§Ù„Ø³ÙƒÙˆÙ†</div></li>
                            <li><div class="node">Ø­Ø°Ù Ø­Ø±Ù Ø§Ù„Ø¹Ù„Ø© Ù„Ø£Ù†Ù‡ Ù…Ø¹ØªÙ„ Ø§Ù„Ø¢Ø®Ø±</div></li>
                            <li>
                                <div class="node">Ø­Ø°Ù Ø§Ù„Ù†ÙˆÙ† Ù„Ø§ØªØµØ§Ù„Ù‡ Ø¨Ù€</div>
                                <ul>
                                    <li><div class="node">Ø£Ù„Ù Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</div></li>
                                    <li><div class="node">ÙˆØ§Ùˆ Ø§Ù„Ø¬Ù…Ø§Ø¹Ø©</div></li>
                                    <li><div class="node">ÙŠØ§Ø¡ Ø§Ù„Ù…Ø®Ø§Ø·Ø¨Ø©</div></li>
                                </ul>
                            </li>
                            <li>
                                <div class="node">Ø§Ù„ÙØªØ­ Ù„Ø§ØªØµØ§Ù„Ù‡ Ø¨Ù†ÙˆÙ† Ø§Ù„ØªÙˆÙƒÙŠØ¯</div>
                                <ul>
                                    <li><div class="node">Ø§Ù„Ø®ÙÙŠÙØ©</div></li>
                                    <li><div class="node">Ø§Ù„Ø«Ù‚ÙŠÙ„Ø©</div></li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Login Overlay -->
    <div id="login-overlay" class="modal-overlay active" style="z-index: 5000; background: var(--bg-color);">
        <div class="login-box">
            <h2 style="margin-bottom: 20px; color: var(--node-text);">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <p style="margin-bottom: 15px; color: #64748b; font-size: 0.9rem;">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</p>
            <input type="email" id="login-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="leaf-input" style="width: 100%; height: 45px; margin-bottom: 10px;">
            <input type="password" id="login-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="leaf-input" style="width: 100%; height: 45px; margin-bottom: 20px;">
            <button id="login-submit-btn" class="add-note-btn" style="width: 100%; padding: 12px; font-size: 1rem; margin-bottom: 10px;">Ø¯Ø®ÙˆÙ„ ğŸ”</button>
        </div>
    </div>

    <!-- Result Box -->
    <div id="irab-box">
        <div style="font-size: 0.8rem; color: #64748b; margin-bottom: 5px;">Ø§Ù„Ù†ØªÙŠØ¬Ø©:</div>
        <div id="irab-text"></div>
        <button class="reset-btn" id="reset-btn">
            â†º Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
        </button>
    </div>

    <!-- Report Modal -->
    <div class="modal-overlay" id="report-modal">
        <div class="modal-content">
            <button class="close-modal" id="close-report">Ø¥ØºÙ„Ø§Ù‚</button>
            <div class="report-title">ØªÙ‚Ø±ÙŠØ± ØªØ­Ù„ÙŠÙ„ Ø³ÙˆØ±Ø© ÙŠÙˆØ³Ù</div>
            <button id="grade-btn" class="add-note-btn" style="width:100%; margin-bottom:15px; background-color:#8b5cf6; display:none;">âœ… ØªØµØ­ÙŠØ­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª (Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹ Ø§Ù„Ø­Ù„)</button>
            <div id="report-body"></div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal-overlay" id="help-modal">
        <div class="modal-content" style="text-align: center;">
            <button class="close-modal" id="close-help">Ø¥ØºÙ„Ø§Ù‚</button>
            <div class="report-title">Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</div>
            <p>Ù¡. Ø§Ø¨Ø¯Ø£ Ù…Ù† "Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©".</p>
            <p>Ù¢. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ù‚Ø³Ù… Ù„ÙØªØ­ ÙØ±ÙˆØ¹Ù‡.</p>
            <p>Ù£. ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø³Ø§Ø± Ø­ØªÙ‰ ØªØµÙ„ Ù„Ù„Ù†Ù‡Ø§ÙŠØ©.</p>
            <p>Ù¤. Ø³ØªØ¸Ù‡Ø± Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„.</p>
        </div>
    </div>

    <!-- Floating Report Button -->
    <button id="show-report-btn" title="ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø§Ù„Ø¨">
        ğŸ“Š <span id="report-badge" style="display:none">0</span>
    </button>
    <button id="logout-btn" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬" style="position: fixed; top: 10px; left: 10px; z-index: 1100; background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; display: none; font-family: 'Tajawal'; font-weight: bold;">
        Ø®Ø±ÙˆØ¬ ğŸšª
    </button>
    <button id="help-btn" title="Ø¯Ù„ÙŠÙ„">ØŸ</button>

    <!-- Toast Container -->
    <div id="toast"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            // --- Firebase Configuration (ØªÚ©Ø§ÛŒÛ• Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛÙ† Ø®Û† Ù„ÛØ±Û• Ø¯Ø§Ù†Û) ---
            const firebaseConfig = {
                apiKey: "AIzaSyAmFk6mXxlWLqFjktkEX3SYF5YtzubGGGw",
  authDomain: "naho-d06fb.firebaseapp.com",
  databaseURL: "https://naho-d06fb-default-rtdb.firebaseio.com",
  projectId: "naho-d06fb",
  storageBucket: "naho-d06fb.firebasestorage.app",
  messagingSenderId: "963866480395",
  appId: "1:963866480395:web:7e5a20ed6962a4c878dc0e",
  measurementId: "G-SPRGPBXKSP"
};

            
            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            let cachedNotesData = {}; // Global storage for notes (Ù…Û•Ø®Ø²Û•Ù†Û Ø¯Ø§ØªØ§ÛŒØ§Ù†)

            // --- Enable Offline Persistence (Ù¾Ø§Ø±Ø§Ø³ØªÙ†Ø§ Ø¯Ø§ØªØ§ÛŒØ§Ù† Ø¨Û Ø¦ÛŒÙ†ØªÛ•Ø±Ù†ÛØª) ---
            db.enablePersistence().catch(err => {
                if (err.code == 'failed-precondition') console.log("Multiple tabs open, persistence disabled");
                else if (err.code == 'unimplemented') console.log("Browser doesn't support persistence");
            });

            // --- Login System ---
            let currentUser = null;
            let isDataLoaded = false; // Safety Flag (Ù‚ÙˆÙÙ„Ø§ Ù¾Ø§Ø±Ø§Ø³ØªÙ†Û)
            let loadError = false; // Flag for load errors
            const loginOverlay = document.getElementById('login-overlay');
            const logoutBtn = document.getElementById('logout-btn');
            const loginSubmitBtn = document.getElementById('login-submit-btn');
            const emailInput = document.getElementById('login-email');
            const passwordInput = document.getElementById('login-password');

            // Handle Login
            loginSubmitBtn.addEventListener('click', () => {
                const email = emailInput.value.trim();
                const password = passwordInput.value.trim();
                if (!email || !password) { alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±!'); return; }
                
                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        showToast(`Ù…Ø±Ø­Ø¨Ø§Ù‹: ${userCredential.user.email}`);
                        loginOverlay.classList.remove('active');
                    })
                    .catch((error) => {
                        alert("Ø®Ø·Ø£: " + error.message);
                    });
            });

            // Auth State Listener
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    loginOverlay.classList.remove('active');
                    logoutBtn.style.display = 'block';
                    loadAllNotes(); // Load from Firestore
                } else {
                    currentUser = null;
                    loginOverlay.classList.add('active');
                    logoutBtn.style.display = 'none';
                }
            });
            
            logoutBtn.addEventListener('click', function() {
                if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                    auth.signOut().then(() => {
                        location.reload();
                    });
                }
            });

            // --- Helper: Get Path for a Leaf Node ---
            function getLeafPath(li) {
                let current = li.querySelector('.node');
                let textParts = [];
                while (current) {
                    // Clean the text to remove the start label and extra spaces
                    // Use textContent instead of innerText to read hidden tabs correctly
                    let text = current.textContent.trim();
                    textParts.unshift(text);
                    let parentLi = current.closest('li').parentElement.closest('li');
                    current = parentLi ? parentLi.querySelector('.node') : null;
                }
                return textParts.join(' ');
            }

            // --- Toast Function (ÙÛ•Ù†Ú©Ø´Ù†Ø§ Ù†ÛŒØ´Ø§Ù†Ø¯Ø§Ù†Ø§ Ù¾Û•ÛŒØ§Ù…Ø§Ù†) ---
            let toastTimeout;
            function showToast(message, duration = 3000, isHtml = false) {
                const toast = document.getElementById("toast");
                if (isHtml) toast.innerHTML = message;
                else toast.innerText = message;
                
                toast.className = "show";
                
                if (toastTimeout) clearTimeout(toastTimeout);
                if (duration > 0) toastTimeout = setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, duration);
            }

            // --- Storage Functions ---
            function saveAllNotes(showSuccessToast = true) {
                if (!currentUser) return Promise.reject("User not logged in"); 
                
                // Safety Check: Prevent overwriting if data hasn't loaded yet
                if (!isDataLoaded) {
                    showToast("âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯! ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...");
                    return Promise.reject("Data not loaded");
                }
                
                if (loadError) {
                    if(!confirm("âš ï¸ ØªØ­Ø°ÙŠØ±: Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ø³Ø¨Ø¨ Ù…Ø´ÙƒÙ„Ø©. Ø¥Ø°Ø§ Ù‚Ù…Øª Ø¨Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¢Ù†ØŒ Ù‚Ø¯ ØªÙÙ‚Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­ÙØ¸ØŸ")) {
                        return Promise.reject("Cancelled by user");
                    }
                }

                // Use cachedNotesData instead of scraping DOM (Ø¨Ú©Ø§Ø±Ø¦ÛŒÙ†Ø§Ù†Ø§ Ù…Û•Ø®Ø²Û•Ù†ÛŒ Ù„ Ø´ÙˆÛŒÙ†Ø§ Ø´Ø§Ø´Û)
                const data = cachedNotesData;
                
                // Save to Firestore
                return db.collection('users').doc(currentUser.uid).set({ notes: data })
                    .then(() => {
                        console.log("Data saved to Firestore");
                        if (showSuccessToast) showToast("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª â˜ï¸");
                    })
                    .catch((error) => {
                        console.error("Error saving document: ", error);
                        showToast("âš ï¸ Ù…Ø´ÙƒÙ„Ø©: " + error.message);
                        throw error;
                    });
            }

            // Make load function available globally for retry button
            window.retryLoad = function() {
                loadAllNotes();
            };

            function loadAllNotes() {
                if (!currentUser) return;
                isDataLoaded = false; // Lock saving until load completes
                loadError = false;
                showToast("â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...");
                document.querySelectorAll('.saved-notes-list').forEach(el => el.remove());

                db.collection('users').doc(currentUser.uid).get().then((doc) => {
                    if (doc.exists) {
                        cachedNotesData = doc.data().notes || {};
                        const data = cachedNotesData;
                        
                        // Ù…Ù„Ø§Ø­Ø¸Ø©: ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù† Ø§Ù„Ø´Ø¬Ø±Ø© Ù„ØªØ¨Ù‚Ù‰ Ù†Ø¸ÙŠÙØ©
                        
                        // Count total notes
                        const count = Object.values(data).reduce((acc, val) => acc + val.length, 0);
                        if (count > 0) showToast(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${count} ÙØ¹Ù„`);
                    }
                    isDataLoaded = true; // Unlock saving
                    updateBadgeCount();
                }).catch((error) => {
                    console.log("Error getting document:", error);
                    showToast(`âš ï¸ ØªÙˆØ¬Ø¯ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„. <button onclick="retryLoad()" style="margin-right:10px; background:white; color:black; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-weight:bold;">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>`, 0, true);
                    loadError = true;
                    isDataLoaded = true; // Unlock to allow manual override
                });
            }

            function updateBadgeCount() {
                const count = Object.values(cachedNotesData).reduce((acc, val) => acc + val.length, 0);
                const badge = document.getElementById('report-badge');
                if (count > 0) {
                    badge.style.display = 'flex';
                    badge.innerText = count;
                } else {
                    badge.style.display = 'none';
                }
            }

            function switchTab(targetId) {
                tabButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.target === targetId);
                });
                tabContents.forEach(content => {
                    content.classList.toggle('active', content.id === targetId);
                });
            }

            tabButtons.forEach(button => {
                button.addEventListener('click', () => switchTab(button.dataset.target));
            });

            // Default
            switchTab('madi');
            
            // Note: loadAllNotes() is now called inside handleLogin()
            // updateBadgeCount();

            // Search Functionality
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.trim();
                const allNodes = document.querySelectorAll('.node');
                const allNotes = document.querySelectorAll('.saved-note-item');
                
                if (!term) {
                    allNodes.forEach(n => {
                        n.classList.remove('dimmed', 'highlight-search');
                    });
                    allNotes.forEach(n => n.style.backgroundColor = '');
                    return;
                }

                allNodes.forEach(n => {
                    if (n.textContent.includes(term)) {
                        n.classList.add('highlight-search');
                        n.classList.remove('dimmed');
                        // Expand parents
                        let parent = n.closest('li');
                        while (parent) {
                            parent.classList.add('expanded');
                            parent = parent.parentElement.closest('li');
                        }
                    } else {
                        n.classList.remove('highlight-search');
                        n.classList.add('dimmed');
                    }
                });

                // Search in Saved Notes
                allNotes.forEach(note => {
                    const text = note.querySelector('.note-text').textContent;
                    if (text.includes(term)) {
                        note.style.backgroundColor = '#fef08a';
                        let parent = note.closest('li');
                        while (parent) {
                            parent.classList.add('expanded');
                            parent = parent.parentElement.closest('li');
                        }
                    } else {
                        note.style.backgroundColor = '';
                    }
                });
            });

            // Advanced Interaction Script
            const nodes = document.querySelectorAll('.node');
            const irabBox = document.getElementById('irab-box');
            const irabText = document.getElementById('irab-text');

            nodes.forEach(node => {
                // 1. Collapsible Logic
                if (node.nextElementSibling && node.nextElementSibling.tagName === 'UL') {
                    node.classList.add('has-children');
                    node.addEventListener('click', function(e) {
                        this.parentElement.classList.toggle('expanded');
                    });
                }

                // 2. Selection & Sentence Builder Logic
                node.addEventListener('click', function(e) {
                    // Highlight selection
                    nodes.forEach(n => n.classList.remove('selected'));
                    this.classList.add('selected');

                    // Build the sentence path
                    let current = this;
                    let textParts = [];
                    let pathNodes = []; // To store the active path
                    
                    while (current) {
                        textParts.unshift(current.textContent.trim());
                        pathNodes.push(current);
                        // Traverse up: Node -> LI -> UL -> Parent LI -> Parent Node
                        let parentLi = current.closest('li').parentElement.closest('li');
                        current = parentLi ? parentLi.querySelector('.node') : null;
                    }

                    // Focus Mode: Dim all other nodes
                    nodes.forEach(n => {
                        if (!pathNodes.includes(n)) {
                            n.classList.add('dimmed');
                        } else {
                            n.classList.remove('dimmed');
                        }
                    });

                    // Show result
                    irabText.innerText = textParts.join(' ');
                    irabBox.classList.add('visible');
                    document.body.classList.add('has-irab-box');

                    // --- NEW LOGIC: Show Input for Leaf Nodes ---
                    const isLeaf = !this.nextElementSibling || this.nextElementSibling.tagName !== 'UL';
                    
                    // Hide all other input containers first
                    document.querySelectorAll('.leaf-input-container').forEach(c => c.classList.remove('visible'));

                    if (isLeaf) {
                        let li = this.closest('li');
                        let container = li.querySelector('.leaf-input-container');
                        
                        if (!container) {
                            // Create container dynamically
                            container = document.createElement('div');
                            container.className = 'leaf-input-container';
                            
                            // Textarea
                            const textarea = document.createElement('textarea');
                            textarea.className = 'leaf-input';
                            textarea.placeholder = 'Ø§ÙƒØªØ¨ ÙØ¹Ù„Ø§Ù‹ Ù…Ù† Ø³ÙˆØ±Ø© ÙŠÙˆØ³Ù...';
                            textarea.addEventListener('click', (ev) => ev.stopPropagation());

                            // Save Button
                            const saveBtn = document.createElement('button');
                            saveBtn.className = 'add-note-btn';
                            saveBtn.innerText = 'Ø­ÙØ¸ ğŸ’¾';
                            saveBtn.addEventListener('click', (ev) => {
                                ev.stopPropagation();
                                const text = textarea.value.trim();
                                if (text) {
                                    // Disable button while saving
                                    saveBtn.disabled = true;
                                    saveBtn.innerText = "â³...";
                                    
                                    
                                    // Update Cache (Ø²ÛØ¯Û•Ú©Ø±Ù† Ø¨Û† Ù…Û•Ø®Ø²Û•Ù†ÛŒ)
                                    const path = getLeafPath(li);
                                    if (!cachedNotesData[path]) cachedNotesData[path] = [];
                                    cachedNotesData[path].push(text);
                                    
                                    
                                    // Save and wait for result
                                    saveAllNotes(true)
                                        .then(() => {
                                            // Success
                                            textarea.value = '';
                                            // Close the box (Ù‡Û•Ù…ÛŒ Ø®Ø§Ù†Û•ÛŒÛÙ† ÙÛ•Ø¨ÛŒÙ† Ø¨Ù‡ÛÙ†Û• Ú¯Ø±ØªØ¨Ù†)
                                            document.querySelectorAll('.leaf-input-container').forEach(c => c.classList.remove('visible'));
                                            
                                            // Collapse Tree (Ø¯Ø§Ø± Ø­Û•ØªØ§Ø¨Ù†ÛŒ Ø¯Û Ù‡ÛØªÛ• Ú¯Ø±ØªÙ†)
                                            document.querySelectorAll('li.expanded').forEach(el => el.classList.remove('expanded'));
                                            document.querySelectorAll('.node').forEach(n => n.classList.remove('selected', 'dimmed', 'highlight-search'));
                                            document.getElementById('irab-box').classList.remove('visible');
                                            document.body.classList.remove('has-irab-box');
                                        })
                                        .catch((err) => {
                                            // Error handled in saveAllNotes, but we can alert too
                                            alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸! ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.");
                                        })
                                        .finally(() => {
                                            saveBtn.disabled = false;
                                            saveBtn.innerText = 'Ø­ÙØ¸ ğŸ’¾';
                                        });
                                }
                            });

                            container.appendChild(textarea);
                            container.appendChild(saveBtn);
                            li.appendChild(container);
                        }
                        
                        // Show this container
                        container.classList.add('visible');
                        
                        // Scroll to view on mobile
                        setTimeout(() => container.scrollIntoView({behavior: 'smooth', block: 'center'}), 100);
                    }
                });
            });

            // Reset Button
            document.getElementById('reset-btn').addEventListener('click', () => {
                nodes.forEach(n => {
                    n.classList.remove('selected', 'dimmed', 'highlight-search');
                });
                document.getElementById('irab-box').classList.remove('visible');
                document.body.classList.remove('has-irab-box');
                document.getElementById('search-input').value = '';
                document.querySelectorAll('.leaf-input-container').forEach(c => c.classList.remove('visible'));
            });

            // Report Logic
            const reportModal = document.getElementById('report-modal');
            const reportBody = document.getElementById('report-body');
            const gradeBtn = document.getElementById('grade-btn');
            
            // Master Key for Grading (Ø­Ù„ÙˆÙ„ Ø³ÙˆØ±Ø© ÙŠÙˆØ³Ù - Ø£ÙˆÙ„ 30 Ø¢ÙŠØ©)
            const MASTER_KEY = {
                "Ù…Ø¶Ø§Ø±Ø¹ Ù…Ø¬Ø²ÙˆÙ… ÙˆØ¹Ù„Ø§Ù…Ø© Ø¬Ø²Ù…Ù‡ Ø­Ø°Ù Ø­Ø±Ù Ø§Ù„Ø¹Ù„Ø© Ù„Ø£Ù†Ù‡ Ù…Ø¹ØªÙ„ Ø§Ù„Ø¢Ø®Ø±": ["ÙŠØ®Ù„"],
                "Ù…Ø¶Ø§Ø±Ø¹ Ù…Ø¬Ø²ÙˆÙ… ÙˆØ¹Ù„Ø§Ù…Ø© Ø¬Ø²Ù…Ù‡ Ø§Ù„Ø³ÙƒÙˆÙ†": ["Ù„Ø§ ØªÙ‚ØµØµ", "ÙŠÙ„ØªÙ‚Ø·Ù‡", "ÙŠØ±ØªØ¹", "ÙŠÙ„Ø¹Ø¨"],
                "Ù…Ø¶Ø§Ø±Ø¹ Ù…Ø±ÙÙˆØ¹ ÙˆØ¹Ù„Ø§Ù…Ø© Ø±ÙØ¹Ù‡ Ø«Ø¨ÙˆØª Ø§Ù„Ù†ÙˆÙ†": ["ØªØ¹Ù‚Ù„ÙˆÙ†", "ÙŠØ´Ø¹Ø±ÙˆÙ†", "ÙŠØ¨ÙƒÙˆÙ†", "ØªØµÙÙˆÙ†", "ÙŠØ¹Ù…Ù„ÙˆÙ†", "ÙŠØ¹Ù„Ù…ÙˆÙ†"],
                "Ù…Ø§Ø¶Ù Ù…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„ÙØªØ­ Ù„Ø£Ù†Ù‡ Ù„Ù… ÙŠØªØµÙ„ Ø¨Ø¢Ø®Ø±Ù‡ Ø´ÙŠØ¡": ["Ù‚Ø§Ù„", "Ø£ØªÙ…Ù‡Ø§", "ÙƒØ§Ù†", "Ù‚Ø§Ù„", "Ù‚Ø§Ù„", "Ø£ÙƒÙ„Ù‡", "ÙØ£ÙƒÙ„Ù‡", "Ø³ÙˆÙ„Øª", "Ø¬Ø§Ø¡Øª", "ÙØ£Ø¯Ù„Ù‰", "Ù‚Ø§Ù„", "Ø§Ø´ØªØ±Ù‰", "Ø¨Ù„Øº", "Ø±Ø§ÙˆØ¯Øª", "ØºÙ„Ù‚Øª", "Ù‚Ø§Ù„Øª", "Ù‚Ø§Ù„", "Ø£Ø­Ø³Ù†", "Ù‡Ù…Øª", "Ù‡Ù…", "Ø±Ø£Ù‰", "Ø§Ø³ØªØ¨Ù‚Ø§", "Ù‚Ø¯Øª", "Ø£Ù„ÙÙŠØ§", "Ù‚Ø§Ù„Øª", "Ø£Ø±Ø§Ø¯", "Ø±Ø§ÙˆØ¯ØªÙ†ÙŠ", "Ø´Ù‡Ø¯", "ÙƒØ§Ù†", "Ù‚Ø¯", "ØµØ¯Ù‚Øª", "ÙƒØ§Ù†", "Ù‚Ø¯", "ÙƒØ°Ø¨Øª", "Ø±Ø£Ù‰", "Ù‚Ø¯", "Ù‚Ø§Ù„", "Ù‚Ø§Ù„", "Ø´ØºÙÙ‡Ø§"],
                "Ù…Ø§Ø¶Ù Ù…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¶Ù… Ù„Ø§ØªØµØ§Ù„Ù‡ Ø¨ÙˆØ§Ùˆ Ø§Ù„Ø¬Ù…Ø§Ø¹Ø©": ["Ù‚Ø§Ù„ÙˆØ§", "Ù‚Ø§Ù„ÙˆØ§", "Ø°Ù‡Ø¨ÙˆØ§", "Ø£Ø¬Ù…Ø¹ÙˆØ§", "Ø¬Ø§Ø¡ÙˆØ§", "Ù‚Ø§Ù„ÙˆØ§", "ÙˆØ¬Ø§Ø¡ÙˆØ§", "Ø§Ø±Ø³Ù„ÙˆØ§", "Ø£Ø³Ø±ÙˆÙ‡", "Ø´Ø±ÙˆÙ‡", "ÙƒØ§Ù†ÙˆØ§"],
                "Ø£Ù…Ø± Ù…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰ Ø­Ø°Ù Ø§Ù„Ù†ÙˆÙ† Ù„Ø§ØªØµØ§Ù„Ù‡ Ø¨Ù€ ÙŠØ§Ø¡ Ø§Ù„Ù…Ø®Ø§Ø·Ø¨Ø©": ["Ø£ÙƒØ±Ù…ÙŠ", "Ø§Ø³ØªØºÙØ±ÙŠ"],
                "Ø£Ù…Ø± Ù…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙƒÙˆÙ†": ["Ø£Ø±Ø³Ù„Ù‡", "Ø£Ø¹Ø±Ø¶"],
                "Ù…Ø¶Ø§Ø±Ø¹ Ù…Ù†ØµÙˆØ¨ ÙˆØ¹Ù„Ø§Ù…Ø© Ù†ØµØ¨Ù‡ Ø§Ù„ÙØªØ­Ø© Ø§Ù„Ø¸Ø§Ù‡Ø±Ø©": ["ÙŠØ£ÙƒÙ„Ù‡", "ÙŠÙ†ÙØ¹Ù†Ø§", "Ù†ØªØ®Ø°Ù‡", "ÙˆÙ„Ù†Ø¹Ù„Ù…Ù‡", "Ù„Ù†ØµØ±Ù", "ÙŠØ³Ø¬Ù†"],
                "Ù…Ø¶Ø§Ø±Ø¹ Ù…Ù†ØµÙˆØ¨ ÙˆØ¹Ù„Ø§Ù…Ø© Ù†ØµØ¨Ù‡ Ø­Ø°Ù Ø§Ù„Ù†ÙˆÙ†": ["ÙÙŠÙƒÙŠØ¯ÙˆØ§", "ØªØ°Ù‡Ø¨ÙˆØ§", "Ø£Ù† ÙŠØ¬Ø¹Ù„ÙˆÙ‡"],
                "Ù…Ø¶Ø§Ø±Ø¹ Ù…Ø±ÙÙˆØ¹ ÙˆØ¹Ù„Ø§Ù…Ø© Ø±ÙØ¹Ù‡ Ø§Ù„Ø¶Ù…Ø© Ø§Ù„Ù…Ù‚Ø¯Ø±Ø© Ø¹Ù„Ù‰ (Ø§Ù„ÙˆØ§Ùˆ) Ø£Ùˆ (Ø§Ù„ÙŠØ§Ø¡) Ù„Ù„Ø«Ù‚Ù„": ["ÙŠØ¬ØªØ¨ÙŠÙƒ", "Ù†Ø¬Ø²ÙŠ"],
                "Ø£Ù…Ø± Ù…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰ Ø­Ø°Ù Ø§Ù„Ù†ÙˆÙ† Ù„Ø§ØªØµØ§Ù„Ù‡ Ø¨Ù€ ÙˆØ§Ùˆ Ø§Ù„Ø¬Ù…Ø§Ø¹Ø©": ["Ø§Ù‚ØªÙ„ÙˆØ§", "Ø§Ø·Ø±Ø­ÙˆØ§", "Ø£Ù„Ù‚ÙˆØ§"],
                "Ù…Ø¶Ø§Ø±Ø¹ Ù…Ø±ÙÙˆØ¹ ÙˆØ¹Ù„Ø§Ù…Ø© Ø±ÙØ¹Ù‡ Ø§Ù„Ø¶Ù…Ø© Ø§Ù„Ù…Ù‚Ø¯Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù„Ù Ù„Ù„ØªØ¹Ø°Ø±": ["Ù„Ù†Ø±Ø§Ù‡Ø§"],
                "Ù…Ø¶Ø§Ø±Ø¹ Ù…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„ÙØªØ­ Ù„Ø§ØªØµØ§Ù„Ù‡ Ø¨Ù†ÙˆÙ† Ø§Ù„ØªÙˆÙƒÙŠØ¯ Ø§Ù„Ø«Ù‚ÙŠÙ„Ø©": ["Ù„ØªÙ†Ø¨Ø£Ù†Ù‘Ù‡Ù…"],
                "Ù…Ø§Ø¶Ù Ù…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙƒÙˆÙ† Ù„Ø§ØªØµØ§Ù„Ù‡ Ø¨Ù€ ØªØ§Ø¡ Ø§Ù„ÙØ§Ø¹Ù„": ["ÙƒÙ†Øª", "Ø±Ø£ÙŠØª", "Ø±Ø£ÙŠØªÙ‡Ù…", "ÙƒÙ†ØªÙ…", "ÙƒÙ†Øª"],
                "Ù…Ø§Ø¶Ù Ù…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙƒÙˆÙ† Ù„Ø§ØªØµØ§Ù„Ù‡ Ø¨Ù€ Ù†Ø§ Ø§Ù„ÙØ§Ø¹Ù„ÙŠÙ†": ["Ø£Ù†Ø²Ù„Ù†Ø§", "Ø£ÙˆØ­ÙŠÙ†Ø§", "Ø£ÙˆØ­ÙŠÙ†Ø§", "Ø°Ù‡Ø¨Ù†Ø§", "ØªØ±ÙƒÙ†Ø§", "Ù…ÙƒÙ†Ø§", "Ø¢ØªÙŠÙ†Ø§Ù‡"],
                "Ù…Ø¶Ø§Ø±Ø¹ Ù…Ø±ÙÙˆØ¹ ÙˆØ¹Ù„Ø§Ù…Ø© Ø±ÙØ¹Ù‡ Ø§Ù„Ø¶Ù…Ø© Ø§Ù„Ø¸Ø§Ù‡Ø±Ø©": ["Ù†Ù‚Øµ", "ÙŠØ¹Ù„Ù…Ùƒ", "ÙŠØªÙ…", "ØªØ£Ù…Ù†Ù‘Ø§", "ÙŠØ­Ø²Ù†Ù†ÙŠ", "Ù†Ø³ØªØ¨Ù‚", "ÙŠÙÙ„Ø­", "ØªØ±Ø§ÙˆØ¯"],
                "Ù…Ø¶Ø§Ø±Ø¹ Ù…Ø¬Ø²ÙˆÙ… ÙˆØ¹Ù„Ø§Ù…Ø© Ø¬Ø²Ù…Ù‡ Ø­Ø°Ù Ø§Ù„Ù†ÙˆÙ† Ù„Ø£Ù†Ù‡ Ù…Ù† Ø§Ù„Ø£ÙØ¹Ø§Ù„ Ø§Ù„Ø®Ù…Ø³Ø©": ["ØªÙƒÙˆÙ†ÙˆØ§", "Ù„Ø§ ØªÙ‚ØªÙ„ÙˆØ§"]
            };
            
            document.getElementById('show-report-btn').addEventListener('click', () => {
                reportBody.innerHTML = '';
                const data = cachedNotesData || {};
                
                // Statistics Calculation (Count total verbs written)
                let counts = {
                    total: 0,
                    madi: 0,
                    mudari: 0,
                    amr: 0
                };

                for (const [path, notes] of Object.entries(data)) {
                    const count = notes.length;
                    counts.total += count;
                    if (path.includes('Ù…Ø§Ø¶Ù')) counts.madi += count;
                    else if (path.includes('Ù…Ø¶Ø§Ø±Ø¹')) counts.mudari += count;
                    else if (path.includes('Ø£Ù…Ø±')) counts.amr += count;
                }
                
                gradeBtn.style.display = 'block'; // Show grade button

                // Add Summary Section
                const summaryHTML = `
                    <div class="report-summary">
                        <div class="summary-header">
                            <div style="font-size:1.1rem; font-weight:bold;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙØ¹Ø§Ù„</div>
                            <div style="font-size:2.5rem; color:var(--accent-color); margin:10px 0; font-weight:bold;">${counts.total}</div>
                            <div style="color:#64748b;">ÙØ¹Ù„ Ù…Ø³Ø¬Ù„</div>
                        </div>
                        <div class="summary-row"><span class="summary-label">Ù…Ø§Ø¶Ù</span><span class="summary-value">${counts.madi}</span></div>
                        <div class="summary-row"><span class="summary-label">Ù…Ø¶Ø§Ø±Ø¹</span><span class="summary-value">${counts.mudari}</span></div>
                        <div class="summary-row"><span class="summary-label">Ø£Ù…Ø±</span><span class="summary-value">${counts.amr}</span></div>
                    </div>
                `;
                reportBody.innerHTML = summaryHTML;

                // --- Search Input in Report ---
                const searchInput = document.createElement('input');
                searchInput.type = 'text';
                searchInput.placeholder = 'Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ±...';
                searchInput.className = 'leaf-input';
                searchInput.style.width = '100%';
                searchInput.style.marginBottom = '15px';
                searchInput.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    const lists = document.querySelectorAll('.report-verb-list');
                    
                    lists.forEach(list => {
                        const rows = list.querySelectorAll('.report-verb-row');
                        let hasMatch = false;
                        rows.forEach(row => {
                            const text = row.innerText.toLowerCase();
                            if (text.includes(term)) {
                                row.style.display = 'flex';
                                hasMatch = true;
                            } else {
                                row.style.display = 'none';
                            }
                        });
                        
                        const itemDiv = list.closest('.report-item');
                        if (term === '') {
                            list.classList.remove('expanded');
                            itemDiv.style.display = 'block';
                            const icon = itemDiv.querySelector('.toggle-icon');
                            if(icon) icon.innerText = 'â–¼ Ø¹Ø±Ø¶';
                        } else {
                            if (hasMatch) {
                                itemDiv.style.display = 'block';
                                list.classList.add('expanded');
                                const icon = itemDiv.querySelector('.toggle-icon');
                                if(icon) icon.innerText = 'â–² Ø¥Ø®ÙØ§Ø¡';
                            } else {
                                itemDiv.style.display = 'none';
                            }
                        }
                    });
                });
                reportBody.appendChild(searchInput);

                const hasData = Object.values(data).some(arr => arr.length > 0);
                if (!hasData) {
                    reportBody.innerHTML += '<div style="text-align:center; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø³Ø¬Ù„Ø©.</div>';
                    reportModal.classList.add('active');
                    return;
                }

                // Render Grouped Data
                for (const [path, notesArray] of Object.entries(data)) {
                    if (notesArray.length === 0) continue;
                    
                    const listContainer = document.createElement('div');
                    listContainer.className = 'report-verb-list';

                    notesArray.forEach((noteText, index) => {
                        const verbRow = document.createElement('div');
                        verbRow.className = 'report-verb-row';
                        
                        const textDiv = document.createElement('div');
                        textDiv.className = 'report-verb-text';
                        textDiv.innerText = `${index + 1}. ${noteText}`; // Add numbering
                        
                        const actionsDiv = document.createElement('div');
                        actionsDiv.className = 'report-verb-actions';
                        
                        // Edit Button
                        const editBtn = document.createElement('button');
                        editBtn.innerText = 'âœï¸';
                        editBtn.title = 'ØªØ¹Ø¯ÙŠÙ„';
                        editBtn.onclick = () => {
                            const newText = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©:', noteText);
                            if (newText !== null && newText.trim() !== '') {
                                cachedNotesData[path][index] = newText.trim();
                                saveAllNotes();
                                document.getElementById('show-report-btn').click(); // Refresh Report
                                loadAllNotes(); // Refresh Main UI
                            }
                        };

                        // Delete Button
                        const delBtn = document.createElement('button');
                        delBtn.innerText = 'ğŸ—‘ï¸';
                        delBtn.title = 'Ø­Ø°Ù';
                        delBtn.onclick = () => {
                            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
                                cachedNotesData[path].splice(index, 1);
                                saveAllNotes();
                                document.getElementById('show-report-btn').click(); // Refresh Report
                                loadAllNotes(); // Refresh Main UI
                            }
                        };

                        actionsDiv.appendChild(editBtn);
                        actionsDiv.appendChild(delBtn);
                        
                        verbRow.appendChild(textDiv);
                        verbRow.appendChild(actionsDiv);
                        listContainer.appendChild(verbRow);
                    });

                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'report-item';
                    itemDiv.dataset.path = path; // Store path for accurate grading
                    
                    // Header with Toggle
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'report-path';
                    headerDiv.innerHTML = `<span>ğŸ”¹ ${path} <span style="font-size:0.9em; color:#64748b; font-weight:normal;">(${notesArray.length} Ø¯Ø§Ù†Û•)</span></span> <span class="toggle-icon">â–¼ Ø¹Ø±Ø¶</span>`;
                    headerDiv.onclick = () => {
                        listContainer.classList.toggle('expanded');
                        const icon = headerDiv.querySelector('.toggle-icon');
                        icon.innerText = listContainer.classList.contains('expanded') ? 'â–² Ø¥Ø®ÙØ§Ø¡' : 'â–¼ Ø¹Ø±Ø¶';
                    };

                    itemDiv.appendChild(headerDiv);
                    itemDiv.appendChild(listContainer);
                    reportBody.appendChild(itemDiv);
                }

                // Add Share to Telegram Button
                const shareBtn = document.createElement('button');
                shareBtn.className = 'share-btn';
                shareBtn.innerHTML = 'ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø¨Ø± ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…';
                
                // Function to generate report text
                const generateReportText = (includeVerbs = false) => {
                    let text = "ğŸ“Š *ØªÙ‚Ø±ÙŠØ± ØªØ­Ù„ÙŠÙ„ Ø³ÙˆØ±Ø© ÙŠÙˆØ³Ù*\n";
                    text += "------------------\n";
                    text += `âœ… Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙØ¹Ø§Ù„: ${counts.total} ÙØ¹Ù„\n`;
                    text += `ğŸ“Œ Ù…Ø§Ø¶Ù: ${counts.madi}\n`;
                    text += `ğŸ“Œ Ù…Ø¶Ø§Ø±Ø¹: ${counts.mudari}\n`;
                    text += `ğŸ“Œ Ø£Ù…Ø±: ${counts.amr}\n\n`;
                    
                    if (hasData) {
                        text += "ğŸ“ğŸ“ğŸ“ğŸ“ *Ù…Ù„Ø§Ø­Ø¸Ø§Øª:* \n\n";
                        for (const [path, items] of Object.entries(data)) {
                            if (items.length === 0) continue;
                            text += `ğŸ”¹ ${path} (${items.length})\n`;
                            if (includeVerbs) {
                                items.forEach((noteText, idx) => {
                                    text += `   ${idx + 1}. ${noteText}\n`;
                                });
                                text += "------------------\n";
                            }
                        }
                    } else {
                        text += "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø³Ø¬Ù„Ø©.\n";
                    }
                    return text;
                };

                shareBtn.addEventListener('click', () => {
                    const text = generateReportText(false); // No verbs for Telegram
                    const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(text)}`;
                    window.open(telegramUrl, '_blank');
                });
                reportBody.appendChild(shareBtn);

                // Add Copy Button (For large reports)
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.innerHTML = 'ğŸ“‹ Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ±';
                copyBtn.onclick = () => {
                    const text = generateReportText(false); // No verbs for Copy
                    navigator.clipboard.writeText(text).then(() => alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ±! Ø§Ø°Ù‡Ø¨ Ø§Ù„Ø¢Ù† Ø¥Ù„Ù‰ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… ÙˆÙ‚Ù… Ø¨Ø§Ù„Ù„ØµÙ‚.'));
                };
                reportBody.appendChild(copyBtn);

                // Add TXT Download Button (Best for large reports)
                const txtBtn = document.createElement('button');
                txtBtn.className = 'txt-btn';
                txtBtn.innerHTML = 'ğŸ“„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Ù…Ù„Ù Ù†ØµÙŠ)';
                txtBtn.onclick = () => {
                    const text = generateReportText(true); // Keep verbs for TXT
                    const blob = new Blob([text], {type: 'text/plain'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Report_Yusuf_${new Date().toISOString().slice(0,10)}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                };
                reportBody.appendChild(txtBtn);

                reportModal.classList.add('active');
            });
            
            // Levenshtein distance function for typo tolerance (Ù…Û•ÙˆØ¯Ø§ÛŒ Ù„ÛÚ¤ÛÙ†Ø´ØªØ§ÛŒÙ†)
            // This function calculates the number of edits (insertions, deletions, or substitutions)
            // required to change one word into the other. It helps forgive small spelling mistakes.
            function levenshtein(a, b) {
                if (a.length === 0) return b.length;
                if (b.length === 0) return a.length;
                const matrix = [];
                for (let i = 0; i <= b.length; i++) { matrix[i] = [i]; }
                for (let j = 0; j <= a.length; j++) { matrix[0][j] = j; }
                for (let i = 1; i <= b.length; i++) {
                    for (let j = 1; j <= a.length; j++) {
                        const cost = b.charAt(i - 1) === a.charAt(j - 1) ? 0 : 1;
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + cost, // substitution
                            matrix[i][j - 1] + 1,        // insertion
                            matrix[i - 1][j] + 1         // deletion
                        );
                    }
                }
                return matrix[b.length][a.length];
            }

            // Grading Logic
            gradeBtn.addEventListener('click', () => {
                // 1. Reset Headers (Remove old status badges)
                document.querySelectorAll('.report-status-badge').forEach(el => el.remove());

                const rows = document.querySelectorAll('.report-verb-row');
                const lists = document.querySelectorAll('.report-verb-list');
                
                // Expand all lists to show results
                lists.forEach(l => l.classList.add('expanded'));
                document.querySelectorAll('.toggle-icon').forEach(i => i.innerText = 'â–² Ø¥Ø®ÙØ§Ø¡');

                // Advanced helper function to normalize Arabic text for forgiving comparison
                // This handles diacritics (tashkeel) and common spelling variations (hamza, ta marbuta, etc.)
                function normalizeForGrading(text) {
                    if (!text) return "";
                    return text
                        .replace(/[\u064B-\u0652\u0640\u0670\u0674\u06D6-\u06DC\u06DF-\u06E8\u06EA-\u06ED]/g, '') // 1. Remove diacritics
                        .replace(/[Ø£Ø¥Ø¢]/g, 'Ø§') // 2. Unify Alef forms
                        .replace(/Ù‰/g, 'ÙŠ')    // 3. Unify Alef Maqsura to Ya
                        .replace(/Ø©/g, 'Ù‡')    // 4. Unify Ta Marbuta to Ha
                        .replace(/Ø¤/g, 'Ùˆ')    // 5. Unify Hamza on Waw to Waw
                        .replace(/Ø¦/g, 'ÙŠ');   // 6. Unify Hamza on Ya to Ya
                }

                // Build Reverse Lookup Map with normalized verbs for Fast Checking
                const verbToPath = {};
                for (const [path, verbs] of Object.entries(MASTER_KEY)) {
                    verbs.forEach(v => {
                        verbToPath[normalizeForGrading(v.trim())] = path;
                    });
                }

                // Track correct counts per path to check for missing items
                const pathCorrectCounts = {};

                rows.forEach(row => {
                    const textDiv = row.querySelector('.report-verb-text');
                    // Extract verb text, ignoring numbering and any previous correction hints
                    let verb = textDiv.innerText.split('\n')[0].replace(/^\d+\.\s*/, '').trim();
                    let normalizedVerb = normalizeForGrading(verb);
                    
                    // Find current path of this row
                    const listContainer = row.closest('.report-verb-list');
                    const itemDiv = listContainer.closest('.report-item');
                    const currentPath = itemDiv.dataset.path; // Use dataset for accuracy

                    // Check correctness using normalized versions
                    const correctVerbsForThisPath = MASTER_KEY[currentPath] || [];
                    const normalizedCorrectVerbs = correctVerbsForThisPath.map(v => normalizeForGrading(v));
                    
                    // --- Advanced Check with Levenshtein Distance for typo tolerance ---
                    let isSimilarEnough = false;
                    for (const correctNormalizedVerb of normalizedCorrectVerbs) {
                        const distance = levenshtein(normalizedVerb, correctNormalizedVerb);
                        // Allow 1 error for words up to 5 chars, 2 for longer.
                        // A distance of 0 is a perfect match.
                        const threshold = correctNormalizedVerb.length <= 5 ? 1 : 2;
                        if (distance <= threshold) {
                            isSimilarEnough = true;
                            break;
                        }
                    }

                    if (isSimilarEnough) {
                        // Correct!
                        row.classList.add('correct');
                        row.classList.remove('wrong');
                        const existingHint = row.querySelector('.correction-hint');
                        if (existingHint) existingHint.remove();
                        
                        // Count correct answers for this path
                        pathCorrectCounts[currentPath] = (pathCorrectCounts[currentPath] || 0) + 1;
                    } else {
                        // Wrong - Now with smarter hints for typos
                        row.classList.add('wrong');
                        row.classList.remove('correct');
                        
                        let correctPath = verbToPath[normalizedVerb];

                        // If exact match fails (due to typo), find the closest match in the entire answer key
                        if (!correctPath) {
                            let bestMatchPath = null;
                            let minDistanceOverall = 3; // Don't suggest if it's too different (e.g., > 2 errors)

                            for (const [path, verbs] of Object.entries(MASTER_KEY)) {
                                for (const verb of verbs) {
                                    const normalizedMasterVerb = normalizeForGrading(verb);
                                    const distance = levenshtein(normalizedVerb, normalizedMasterVerb);
                                    if (distance < minDistanceOverall) {
                                        minDistanceOverall = distance;
                                        bestMatchPath = path;
                                    }
                                }
                            }
                            if (bestMatchPath) correctPath = bestMatchPath;
                        }

                        let hintText = correctPath 
                            ? `âŒ Ø®Ø·Ø£! Ø§Ù„ØµÙˆØ§Ø¨: ${correctPath}`
                            : `âš ï¸ Ø®Û•Ù„Û•ØªÛ•! (Ø¦Û•Ú¤Û• ÛŒØ§ Ø²ÛØ¯Û•ÛŒÛ•)`;

                        let hintElement = row.querySelector('.correction-hint');
                        if (!hintElement) { hintElement = document.createElement('span'); hintElement.className = 'correction-hint'; textDiv.appendChild(hintElement); }
                        hintElement.innerText = hintText;
                    }
                });

                // Check for Missing Answers (Under-answering)
                document.querySelectorAll('.report-item').forEach(itemDiv => {
                    const currentPath = itemDiv.dataset.path;
                    const pathSpan = itemDiv.querySelector('.report-path span');
                    
                    const totalExpected = (MASTER_KEY[currentPath] || []).length;
                    const userCorrect = pathCorrectCounts[currentPath] || 0;

                    const statusSpan = document.createElement('span');
                    statusSpan.className = 'report-status-badge';
                    statusSpan.style.marginRight = '10px';
                    statusSpan.style.fontSize = '0.85rem';
                    statusSpan.style.fontWeight = 'bold';

                    if (totalExpected > 0) {
                        const missing = totalExpected - userCorrect;
                        if (missing > 0) {
                            statusSpan.style.color = '#d97706'; // Orange
                            statusSpan.innerText = `(Ù‡ÛØ´ØªØ§ ${missing} Ù¾ÛØªÚ¤ÛŒÙ†Û•)`;
                        } else {
                            statusSpan.style.color = '#10b981'; // Green
                            statusSpan.innerText = `(ØªÛ•Ù…Ø§Ù…Û• âœ…)`;
                        }
                    } else {
                        // Path not in Master Key (Extra Category)
                        statusSpan.style.color = '#ef4444';
                        statusSpan.innerText = `(Ø¦Û•Ú¤ Ø¨Û•Ø´Û• ÛŒØ§ Ø²ÛØ¯Û•ÛŒÛ• âŒ)`;
                    }
                    pathSpan.appendChild(statusSpan);
                });
                
                gradeBtn.style.display = 'none'; // Hide button after grading
                showToast("âœ… ØªÙ… ØªØµØ­ÙŠØ­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª!", 3000);
            });

            document.getElementById('close-report').addEventListener('click', () => {
                reportModal.classList.remove('active');
            });

            // Help Modal Logic
            const helpModal = document.getElementById('help-modal');
            document.getElementById('help-btn').addEventListener('click', () => {
                helpModal.classList.add('active');
            });
            document.getElementById('close-help').addEventListener('click', () => {
                helpModal.classList.remove('active');
            });

        });
    </script>

</body>
</html>
